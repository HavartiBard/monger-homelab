# DNS Records Workflow

## Overview

DNS records are managed through a simplified two-file system that gets merged into the final `dns_zones.yml`.

## File Structure

```
config/
├── dns_records_manual.conf     # Human-edited records
├── dns_records_terraform.conf  # Auto-generated by Terraform
├── dns_zones.yml               # Generated (DO NOT EDIT)
└── DNS_RECORDS_WORKFLOW.md     # This file
```

## Workflow

### Adding/Updating Manual Records

1. **Edit the simple config file:**
   ```bash
   vim config/dns_records_manual.conf
   ```

2. **Add a record inside a zone section:**
   ```
   ZONE: lab.klsll.com
   # Format: name,type,value,ttl
   # PTR records are auto-generated from A records!
   new-server,A,192.168.20.110,3600
   ENDZONE
   ```

3. **Generate the YAML:**
   ```bash
   python3 scripts/generate_dns_zones.py
   ```

4. **Deploy to DNS servers:**
   ```bash
   ansible-playbook -i inventory/raclette/inventory.ini playbook/configure_dns_zones.yml
   ```

### Terraform Integration (Future)

When Terraform creates VMs, it will:
1. Write records to `dns_records_terraform.conf`
2. Automatically run `generate_dns_zones.py`
3. Optionally trigger Ansible deployment

### Auto-Generated PTR Records

**You don't need to manually create PTR records!**

The script automatically generates reverse DNS (PTR) records from all A records:
- `pve1,A,192.168.20.100,lab.klsll.com,3600`
- → Auto-generates: `100,PTR,pve1.lab.klsll.com.,20.168.192.in-addr.arpa,3600`

This ensures forward and reverse DNS are always in sync!

## Record Format

### Simple Text Format (Input)

```
# Comments start with #
# Format:
#   ZONE: <zone-name>
#   name,type,value,ttl
#   ENDZONE

ZONE: lab.klsll.com

# A Records
server1,A,192.168.20.10,3600
server2,A,192.168.20.11,3600

# CNAME Records
www,CNAME,server1.lab.klsll.com.,3600

ENDZONE

# PTR Records are AUTO-GENERATED from A records - don't add them manually!
```

### YAML Format (Output)

The script generates proper Ansible-compatible YAML:

```yaml
dns_zones:
  - name: "lab.klsll.com"
    type: "Primary"
    records:
      - name: "server1"
        type: "A"
        ttl: 3600
        value: "192.168.20.10"
```

## Benefits

✅ **Simple editing** - One line per record, easy to read/edit  
✅ **Zone sections** - No need to repeat zone name for each record  
✅ **Version control** - Text files are easy to diff  
✅ **Separation** - Manual vs auto-generated records  
✅ **Auto-PTR** - Reverse DNS generated automatically  
✅ **Validation** - Script can validate before generating  
✅ **Flexibility** - Easy to extend with more sources  

## Examples

### Add a new server

```bash
# 1. Add A record (PTR is auto-generated!)
echo "k8s-master1,A,192.168.20.110,lab.klsll.com,3600" >> config/dns_records_manual.conf

# 2. Generate YAML (includes auto-generated PTR)
python3 scripts/generate_dns_zones.py

# 3. Deploy
ansible-playbook -i inventory/raclette/inventory.ini playbook/configure_dns_zones.yml
```

### Add a CNAME alias

```bash
# 1. Add to manual records
echo "k8s,CNAME,k8s-master1.lab.klsll.com.,lab.klsll.com,3600" >> config/dns_records_manual.conf

# 2. Generate and deploy
python3 scripts/generate_dns_zones.py
ansible-playbook -i inventory/raclette/inventory.ini playbook/configure_dns_zones.yml
```

## Migration from Old Format

To migrate from the old `dns_zones.yml`:

```bash
# Backup the old file
cp config/dns_zones.yml config/dns_zones.yml.backup

# The manual records file already contains your current records
# Just generate the new format
python3 scripts/generate_dns_zones.py
```

## Future Enhancements

1. **Validation** - Check for duplicate IPs, invalid formats
2. **Terraform integration** - Auto-generate from VM resources
3. **Git hooks** - Auto-generate on commit
4. **Import tool** - Convert existing zones to simple format
5. **Web UI** - Simple form to add records

## Troubleshooting

### Script fails to run

```bash
# Install PyYAML if needed
pip3 install pyyaml
```

### Records not appearing

Check the script output for warnings about invalid lines.

### Want to see what changed

```bash
git diff config/dns_zones.yml
```
